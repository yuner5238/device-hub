<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>设备详情</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f2f2f7;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .apple-card {
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      padding: 30px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1d1d1f;
    }

    .el-form-item__label {
      font-weight: 500;
      color: #3c3c43;
    }

    .top-actions {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    @media (max-width: 600px) {
      .apple-card {
        padding: 20px;
        border-radius: 16px;
      }

      .section-title {
        font-size: 20px;
      }
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <div class="apple-card" v-loading="loading">
      <div class="top-actions">
        <h2 class="section-title">设备详情</h2>
        <el-button type="text" @click="goHome">主页</el-button>
      </div>

      <div v-if="!device">
        <el-alert title="未找到设备" type="error" show-icon></el-alert>
      </div>

      <div v-else>
        <el-form :model="device" label-width="100px" label-position="left" v-if="!editMode">
          <el-form-item label="设备名称">{{ device.name || '未命名' }}</el-form-item>
          <el-form-item label="位置">{{ device.location || '未知' }}</el-form-item>
          <el-form-item label="购买日期">{{ device.purchase_date || 'N/A' }}</el-form-item>
          <el-form-item label="安装日期">{{ device.install_date || device.purchase_date || 'N/A' }}</el-form-item>
          <el-form-item label="备注">{{ device.notes || '无备注' }}</el-form-item>
        </el-form>

        <el-form :model="editForm" label-width="100px" label-position="left" v-else>
          <el-form-item label="位置">
            <el-input v-model="editForm.location"></el-input>
          </el-form-item>
          <el-form-item label="购买日期">
            <el-date-picker v-model="editForm.purchase_date" type="date" placeholder="选择日期"></el-date-picker>
          </el-form-item>
          <el-form-item label="安装日期">
            <el-date-picker v-model="editForm.install_date" type="date" placeholder="选择日期"></el-date-picker>
          </el-form-item>
          <el-form-item label="备注">
            <el-input type="textarea" v-model="editForm.notes" :rows="3"></el-input>
          </el-form-item>
          <el-form-item label="编辑密码">
            <el-input v-model="editPassword" type="password"></el-input>
          </el-form-item>
        </el-form>

        <div style="margin-top: 20px;">
          <el-button v-if="!editMode" type="primary" @click="editMode = true">编辑</el-button>
          <el-button v-else type="success" @click="saveEdit">保存</el-button>
          <el-button v-if="editMode" @click="cancelEdit">取消</el-button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.appspot.com",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        loading: true,
        device: null,
        editMode: false,
        editPassword: '',
        editForm: {
          location: '',
          purchase_date: '',
          install_date: '',
          notes: ''
        }
      },
      created() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (id) {
          this.fetchDevice(id);
        } else {
          this.loading = false;
        }
      },
      methods: {
        fetchDevice(id) {
          db.ref('devices/' + id).once('value').then(snapshot => {
            if (snapshot.exists()) {
              this.device = snapshot.val();
              this.device.id = id;
            }
            this.loading = false;
          });
        },
        saveEdit() {
          if (this.editPassword !== '123456') {
            this.$message.error("密码错误");
            return;
          }
          const updates = {
            location: this.editForm.location,
            notes: this.editForm.notes,
            purchase_date: this.editForm.purchase_date,
            install_date: this.editForm.install_date
          };
          db.ref('devices/' + this.device.id).update(updates).then(() => {
            Object.assign(this.device, updates);
            this.$message.success("保存成功");
            this.editMode = false;
          });
        },
        cancelEdit() {
          this.editMode = false;
        },
        goHome() {
          window.location.href = "index.html";
        }
      },
      watch: {
        editMode(newVal) {
          if (newVal && this.device) {
            this.editForm.location = this.device.location;
            this.editForm.notes = this.device.notes;
            this.editForm.purchase_date = this.device.purchase_date || '';
            this.editForm.install_date = this.device.install_date || this.device.purchase_date || '';
            this.editPassword = '';
          }
        }
      }
    });
  </script>
</body>

</html>
