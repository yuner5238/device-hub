<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>设备详情 - Device Hub</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif;
      background: #fff;
      color: #1d1d1f;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
      font-weight: 400;
      font-size: 17px;
    }
    .container {
      max-width: 720px;
      margin: 40px auto;
      padding: 0 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    h1 {
      font-weight: 600;
      font-size: 28px;
      letter-spacing: -.02em;
      margin-bottom: 12px;
    }
    .label {
      color: #6e6e73;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .value {
      font-size: 18px;
      color: #1d1d1f;
      margin-bottom: 12px;
      border-bottom: 1px solid #d2d2d7;
      padding-bottom: 6px;
    }
    .input-el {
      width: 100%;
    }
    .btn-edit {
      align-self: flex-end;
      font-weight: 600;
      color: #0071e3;
      cursor: pointer;
      user-select: none;
      margin-bottom: 24px;
    }
    .btn-save {
      background-color: #0071e3;
      border-color: #0071e3;
      color: white;
      font-weight: 600;
      width: 100%;
    }
    .btn-save:disabled {
      background-color: #a2a2a6;
      border-color: #a2a2a6;
    }
    @media (max-width: 600px) {
      .container {
        margin: 24px 16px;
      }
      h1 {
        font-size: 24px;
      }
      .value, .input-el {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <h1>{{ device.name || '加载中...' }}</h1>

    <div v-if="!editMode">
      <div>
        <div class="label">位置</div>
        <div class="value">{{ device.location || '-' }}</div>
      </div>
      <div>
        <div class="label">采购日期</div>
        <div class="value">{{ device.purchase_date || '-' }}</div>
      </div>
      <div>
        <div class="label">安装日期</div>
        <div class="value">{{ device.install_date || device.purchase_date || '-' }}</div>
      </div>      
      <div>
        <div class="label">备注</div>
        <div class="value">{{ device.note || '-' }}</div>
      </div>
      <div class="btn-edit" @click="tryEdit">编辑设备信息</div>
    </div>

    <div v-else>
      <el-form :model="form" label-position="top" size="medium" class="input-el">
        <el-form-item label="位置">
          <el-input v-model="form.location" placeholder="请输入位置"></el-input>
        </el-form-item>
        <el-form-item label="备注">
          <el-input type="textarea" v-model="form.note" placeholder="请输入备注" rows="3"></el-input>
        </el-form-item>
        <el-form-item label="采购日期">
          <el-date-picker
            v-model="form.purchase_date"
            type="date"
            placeholder="请选择采购日期"
            style="width: 100%;"
            format="yyyy-MM-dd"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="安装日期">
          <el-date-picker
            v-model="form.install_date"
            type="date"
            placeholder="请选择安装日期"
            style="width: 100%;"
            format="yyyy-MM-dd"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-button type="primary" class="btn-save" :disabled="loading" @click="save">保存</el-button>
        <el-button style="margin-left: 12px;" @click="cancelEdit">取消</el-button>
      </el-form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        deviceId: null,
        device: {},
        editMode: false,
        loading: false,
        form: {
          location: '',
          notes: '',
          purchase_date: '',
          install_date: '',
        },
        editPassword: '123456',
      },
      created() {
        const urlParams = new URLSearchParams(window.location.search);
        this.deviceId = urlParams.get('id');
        if (!this.deviceId) {
          alert('无效的设备ID');
          return;
        }
        this.loadDevice();
      },
      methods: {
        loadDevice() {
          db.ref(`devices/${this.deviceId}`).once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
              this.device = data;
              // 默认安装日期等于采购日期（如果无安装日期）
              if (!this.device.install_date && this.device.purchase_date) {
                this.device.install_date = this.device.purchase_date;
              }
            } else {
              alert('设备不存在');
            }
          }).catch(() => {
            alert('加载设备失败');
          });
        },
        tryEdit() {
          this.$prompt('请输入编辑密码', '密码验证', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            inputType: 'password',
            inputPlaceholder: '请输入密码'
          }).then(({ value }) => {
            if (value === this.editPassword) {
              this.startEdit();
            } else {
              this.$message.error('密码错误');
            }
          }).catch(() => {});
        },
        startEdit() {
          this.editMode = true;
          this.form.location = this.device.location || '';
          this.form.note = this.device.note || '';
          this.form.purchase_date = this.device.purchase_date || '';
          this.form.install_date = this.device.install_date || this.device.purchase_date || '';
        },
        cancelEdit() {
          this.editMode = false;
        },
        save() {
          if (this.loading) return;
          this.loading = true;
          const updates = {
            location: this.form.location.trim(),
            note: this.form.note.trim(),
            purchase_date: this.form.purchase_date,
            install_date: this.form.install_date || this.form.purchase_date,
          };
          db.ref(`devices/${this.deviceId}`).update(updates).then(() => {
            this.$message.success('保存成功');
            this.device = {...this.device, ...updates};
            this.editMode = false;
          }).catch(() => {
            this.$message.error('保存失败');
          }).finally(() => {
            this.loading = false;
          });
        }
      }
    });
  </script>
</body>
</html>
