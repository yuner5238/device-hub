<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>è®¾å¤‡è¯¦æƒ…</title>
  <!-- Element UI å’Œ Vue.js ä¿æŒä¸å˜ -->
  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />

  <!-- ğŸ’¡ æ”¹è¿›: å¯¼å…¥ Firebase æ¨¡å—åŒ– SDK -->
  <!-- åªéœ€è¦å¯¼å…¥ä½ éœ€è¦çš„éƒ¨åˆ†ï¼Œè¿™é‡Œæ˜¯ app å’Œ database -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, once, update } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js'; // å¯¼å…¥ Authentication
    
    // å°† Firebase æ¨¡å—å¯¼å‡ºåˆ°å…¨å±€èŒƒå›´ï¼Œä»¥ä¾¿ Vue å®ä¾‹å¯ä»¥è®¿é—®
    // æ³¨æ„ï¼šåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ›´å¥½çš„åšæ³•æ˜¯å°† Firebase åˆå§‹åŒ–å’Œæ“ä½œå°è£…æˆæœåŠ¡æˆ–æ’ä»¶
    window.FirebaseApp = { initializeApp, getDatabase, ref, once, update, getAuth, signInAnonymously, onAuthStateChanged };
  </script>

  <style>
    body {
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <el-card v-loading="loading">
      <h2 style="margin-bottom: 20px">è®¾å¤‡è¯¦æƒ…</h2>

      <div v-if="!device && !loading">
        <el-alert title="æœªæ‰¾åˆ°è®¾å¤‡" type="error"></el-alert>
      </div>

      <div v-else-if="device">
        <el-form :model="device" label-width="120px" label-position="left" v-if="!editMode">
          <el-form-item label="è®¾å¤‡åç§°">{{ device.name || 'N/A' }}</el-form-item>
          <el-form-item label="ä½ç½®">{{ device.location || 'N/A' }}</el-form-item>
          <el-form-item label="ä¸Šæ¬¡ç»´æŠ¤">{{ device.last_maintenance || 'N/A' }}</el-form-item>
          <el-form-item label="å¤‡æ³¨">{{ device.notes || 'æ— ' }}</el-form-item>
        </el-form>

        <el-form :model="editForm" label-width="120px" label-position="left" v-else>
          <el-form-item label="ä½ç½®">
            <el-input v-model="editForm.location"></el-input>
          </el-form-item>
          <el-form-item label="å¤‡æ³¨">
            <el-input type="textarea" v-model="editForm.notes" :rows="3"></el-input>
          </el-form-item>
          <!-- ğŸ’¡ ç§»é™¤ç¡¬ç¼–ç å¯†ç è¾“å…¥æ¡†ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ Firebase Authentication -->
          <!-- <el-form-item label="ç¼–è¾‘å¯†ç ">
            <el-input type="password" v-model="editPassword"></el-input>
          </el-form-item> -->
        </el-form>

        <div style="margin-top: 20px">
          <!-- ğŸ’¡ ä»…å½“ç”¨æˆ·å·²è®¤è¯æ—¶æ‰æ˜¾ç¤ºâ€œç¼–è¾‘â€æŒ‰é’® -->
          <el-button v-if="!editMode && isAuthenticated" type="primary" @click="enterEditMode">ç¼–è¾‘</el-button>
          <el-button v-else-if="editMode" type="success" @click="saveEdit">ä¿å­˜</el-button>
          <el-button v-if="editMode" @click="cancelEdit">å–æ¶ˆ</el-button>
          <el-alert v-if="!isAuthenticated && !loading" title="è¯·ç™»å½•ä»¥ç¼–è¾‘è®¾å¤‡ä¿¡æ¯" type="info" show-icon :closable="false" style="margin-top: 20px;"></el-alert>
        </div>
      </div>
    </el-card>
  </div>

  <script type="module">
    // ğŸ’¡ ä»å…¨å±€å¯¹è±¡ä¸­è·å– Firebase æ¨¡å—
    const { initializeApp, getDatabase, ref, once, update, getAuth, signInAnonymously, onAuthStateChanged } = window.FirebaseApp;

    // ğŸ’¡ ä½ åªéœ€è¦æ›¿æ¢ apiKey å’Œ appId
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };


    // åˆå§‹åŒ– Firebase åº”ç”¨
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); // è·å– Realtime Database æœåŠ¡
    const auth = getAuth(app);   // è·å– Authentication æœåŠ¡

    new Vue({
      el: '#app',
      data: {
        loading: true,
        device: null,
        editMode: false,
        editForm: {
          location: '',
          notes: ''
        },
        // ğŸ’¡ ç§»é™¤ editPassword
        // editPassword: '',
        isAuthenticated: false, // ğŸ’¡ æ–°å¢ï¼šç”¨æˆ·æ˜¯å¦è®¤è¯çŠ¶æ€
      },
      created() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        // ğŸ’¡ ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // ç”¨æˆ·å·²ç™»å½• (åŒ¿åæˆ–é€šè¿‡å…¶ä»–æ–¹å¼)
            this.isAuthenticated = true;
            console.log('ç”¨æˆ·å·²ç™»å½•:', user.uid);
          } else {
            // ç”¨æˆ·æœªç™»å½•ï¼Œå°è¯•åŒ¿åç™»å½•
            this.isAuthenticated = false;
            signInAnonymously(auth)
              .then(() => {
                console.log('åŒ¿åç™»å½•æˆåŠŸ');
              })
              .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.error('åŒ¿åç™»å½•å¤±è´¥:', errorCode, errorMessage);
                this.$message.error('ç™»å½•å¤±è´¥: ' + errorMessage);
              });
          }
          // åœ¨è®¤è¯çŠ¶æ€ç¡®å®šåï¼Œå†åŠ è½½è®¾å¤‡æ•°æ®
          if (id) {
            this.fetchDeviceData(id);
          } else {
            this.loading = false;
          }
        });
      },
      methods: {
        fetchDeviceData(id) {
          this.loading = true; // ç¡®ä¿åœ¨é‡æ–°åŠ è½½æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          // ğŸ’¡ ä½¿ç”¨æ¨¡å—åŒ– SDK çš„ ref å’Œ once å‡½æ•°
          once(ref(db, 'devices/' + id)).then(snapshot => {
            if (snapshot.exists()) {
              this.device = snapshot.val();
              this.device.id = id;
            } else {
              this.device = null; // è®¾å¤‡ä¸å­˜åœ¨æ—¶ï¼Œç½®ç©ºdevice
              this.$message.warning('æœªæ‰¾åˆ°æŒ‡å®šè®¾å¤‡ï¼'); // ğŸ’¡ å‹å¥½æç¤º
            }
            this.loading = false;
          }).catch(error => {
            this.device = null;
            this.loading = false;
            this.$message.error('åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥: ' + error.message); // ğŸ’¡ é”™è¯¯æç¤º
            console.error("Error fetching device data:", error);
          });
        },
        // ğŸ’¡ æ–°å¢è¿›å…¥ç¼–è¾‘æ¨¡å¼çš„æ–¹æ³•
        enterEditMode() {
          if (this.isAuthenticated) {
            this.editMode = true;
          } else {
            this.$message.warning('æ‚¨æ²¡æœ‰æƒé™ç¼–è¾‘è®¾å¤‡ï¼Œè¯·å…ˆç™»å½•ï¼');
          }
        },
        saveEdit() {
          // ğŸ’¡ ç¡®ä¿åªæœ‰è®¤è¯ç”¨æˆ·æ‰èƒ½ä¿å­˜
          if (!this.isAuthenticated) {
            this.$message.error('æ‚¨æ²¡æœ‰æƒé™ä¿å­˜æ›´æ”¹ï¼');
            return;
          }

          // ğŸ’¡ ç§»é™¤ç¡¬ç¼–ç å¯†ç æ£€æŸ¥
          // if (this.editPassword !== 'bianji') {
          //   this.$message.error('ç¼–è¾‘å¯†ç é”™è¯¯');
          //   return;
          // }

          // ğŸ’¡ ä½¿ç”¨æ¨¡å—åŒ– SDK çš„ ref å’Œ update å‡½æ•°
          update(ref(db, 'devices/' + this.device.id), {
            location: this.editForm.location,
            notes: this.editForm.notes
          }).then(() => {
            this.device.location = this.editForm.location;
            this.device.notes = this.editForm.notes;
            this.$message.success('ä¿å­˜æˆåŠŸ');
            this.editMode = false;
          }).catch(error => {
            this.$message.error('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message); // ğŸ’¡ é”™è¯¯æç¤º
            console.error("Error saving device data:", error);
          });
        },
        cancelEdit() {
          if (this.device) { // ç¡®ä¿ device å­˜åœ¨æ—¶æ‰èµ‹å€¼
            this.editForm.location = this.device.location;
            this.editForm.notes = this.device.notes;
          }
          this.editMode = false;
        }
      },
      watch: {
        editMode(newVal) {
          if (newVal && this.device) {
            this.editForm.location = this.device.location;
            this.editForm.notes = this.device.notes;
            // ğŸ’¡ ç§»é™¤ editPassword æ¸…ç©º
            // this.editPassword = '';
          }
        }
      }
    });
  </script>
</body>

</html>
