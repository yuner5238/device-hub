<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>DeviceHub - 设备详情</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    body {
      padding: 20px;
      background: #f9f9f9;
    }
    #app {
      max-width: 700px;
      margin: auto;
    }
    .password-dialog .el-dialog__body {
      padding-bottom: 0;
    }
    .edit-buttons {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <el-page-header content="设备详情" @back="goBack" style="margin-bottom: 20px;"></el-page-header>

    <el-card v-if="device" shadow="hover">
      <el-form :model="device" label-width="100px" :disabled="!isEditing">
        <el-form-item label="设备名称">
          <el-input v-model="device.name" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="位置">
          <el-input v-model="device.location"></el-input>
        </el-form-item>
        <el-form-item label="上次维护">
          <el-date-picker
            v-model="device.last_maintenance"
            type="date"
            placeholder="选择日期"
            format="yyyy-MM-dd"
            value-format="yyyy-MM-dd"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="备注">
          <el-input
            type="textarea"
            v-model="device.notes"
            :rows="4"
          ></el-input>
        </el-form-item>
      </el-form>

      <div class="edit-buttons" v-if="!isEditing">
        <el-button type="primary" @click="showPasswordDialog">编辑</el-button>
      </div>

      <div class="edit-buttons" v-else>
        <el-button type="success" @click="saveDevice">保存</el-button>
        <el-button @click="cancelEdit">取消</el-button>
      </div>
    </el-card>

    <el-dialog
      title="请输入编辑密码"
      :visible.sync="passwordDialogVisible"
      width="400px"
      :before-close="() => { inputEditPassword = ''; passwordError = '' }"
      class="password-dialog"
    >
      <el-input
        v-model="inputEditPassword"
        placeholder="编辑密码"
        show-password
        @keyup.enter.native="verifyPassword"
      ></el-input>
      <div style="color: red; margin-top: 10px;" v-if="passwordError">{{ passwordError }}</div>
      <span slot="footer" class="dialog-footer">
        <el-button @click="passwordDialogVisible = false">取消</el-button>
        <el-button type="primary" @click="verifyPassword">确认</el-button>
      </span>
    </el-dialog>

    <el-empty v-if="!device && !loading" description="未找到设备"></el-empty>

    <div v-if="loading" style="text-align:center; margin-top: 50px;">
      <el-spinner type="circle"></el-spinner>
    </div>
  </div>

  <!-- Vue & Element UI & Firebase -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    new Vue({
      el: '#app',
      data: {
        device: null,
        loading: true,
        isEditing: false,
        passwordDialogVisible: false,
        inputEditPassword: '',
        passwordError: '',
      },
      created() {
        this.loadDevice();
      },
      methods: {
        getDeviceId() {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get('id');
        },
        async loadDevice() {
          this.loading = true;
          const id = this.getDeviceId();
          if(!id) {
            this.loading = false;
            return;
          }
          try {
            const snapshot = await database.ref('devices/' + id).once('value');
            this.device = snapshot.val();
            if(this.device) {
              // 格式化日期为字符串（兼容 Element UI 日期选择器）
              if(this.device.last_maintenance) {
                this.device.last_maintenance = this.device.last_maintenance;
              }
            }
          } catch(e) {
            console.error('加载设备失败', e);
          } finally {
            this.loading = false;
          }
        },
        showPasswordDialog() {
          this.passwordDialogVisible = true;
          this.inputEditPassword = '';
          this.passwordError = '';
        },
        verifyPassword() {
          if(this.inputEditPassword === 'bianji') {
            this.isEditing = true;
            this.passwordDialogVisible = false;
            this.passwordError = '';
          } else {
            this.passwordError = '密码错误';
          }
        },
        async saveDevice() {
          if(!this.device) return;
          const id = this.getDeviceId();
          if(!id) return;

          try {
            await database.ref('devices/' + id).update({
              location: this.device.location || '',
              notes: this.device.notes || '',
              last_maintenance: this.device.last_maintenance || '',
            });
            this.$message.success('保存成功');
            this.isEditing = false;
          } catch(e) {
            this.$message.error('保存失败');
            console.error(e);
          }
        },
        cancelEdit() {
          this.isEditing = false;
          this.loadDevice();
        },
        goBack() {
          window.history.back();
        }
      }
    });
  </script>
</body>
</html>
