<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: auto;
    }

    .device-card {
      margin-bottom: 15px;
    }

    .announcement {
      margin-bottom: 20px;
    }

    .el-card__body {
      padding: 16px;
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <h2 style="margin-bottom: 15px">è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</h2>

    <!-- å…¬å‘Šæ  -->
    <el-card class="announcement" shadow="never" v-if="announcements.length">
      <h4 style="margin: 0 0 10px 0;">ğŸ“¢ å…¬å‘Š</h4>
      <ul>
        <li v-for="(item, index) in announcements.slice(0, 3)" :key="index">
          {{ item }}
        </li>
      </ul>
    </el-card>

    <!-- è®¾å¤‡åˆ—è¡¨ -->
    <el-card
      v-for="device in visibleDevices"
      :key="device.id"
      class="device-card"
      shadow="always"
      @click.native="goToDetail(device.id)"
    >
      <div><strong>åç§°ï¼š</strong>{{ device.name }}</div>
      <div><strong>ä½ç½®ï¼š</strong>{{ device.location }}</div>
      <div><strong>ä¸Šæ¬¡ç»´æŠ¤ï¼š</strong>{{ device.last_maintenance }}</div>
    </el-card>

    <!-- åŠ è½½æ›´å¤š -->
    <div v-if="loadingMore" style="text-align: center; margin: 15px;">
      <el-spinner type="snake" />
    </div>
    <div v-if="!hasMore && devices.length > 0" style="text-align: center; color: #888; margin-top: 10px;">
      æ²¡æœ‰æ›´å¤šè®¾å¤‡äº†
    </div>
  </div>

  <script>
    // Firebase é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„å®é™…é…ç½®ï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
  authDomain: "device-hub-5238.firebaseapp.com",
  databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
  projectId: "device-hub-5238",
  storageBucket: "device-hub-5238.appspot.com",
  messagingSenderId: "648686550801",
  appId: "1:648686550801:web:2f460487e32914042316b0",
  measurementId: "G-44L5PHN36Y"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data() {
        return {
          devices: [],
          visibleDevices: [],
          announcements: [],
          batchSize: 5,
          currentIndex: 0,
          hasMore: true,
          loadingMore: false
        };
      },
      created() {
        this.fetchAnnouncements();
        this.fetchDevices();
        window.addEventListener('scroll', this.handleScroll);
      },
      destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
      },
      methods: {
        fetchAnnouncements() {
          // å‡è®¾å…¬å‘Šä¿å­˜åœ¨ /announcements èŠ‚ç‚¹
          db.ref('announcements').once('value').then(snapshot => {
            const data = snapshot.val() || [];
            this.announcements = Array.isArray(data) ? data : Object.values(data);
          });
        },
        fetchDevices() {
          db.ref('devices').once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
              this.devices = Object.entries(data).map(([id, val]) => ({ id, ...val }));
              this.loadMore();
            }
          });
        },
        loadMore() {
          if (!this.hasMore || this.loadingMore) return;
          this.loadingMore = true;
          setTimeout(() => {
            const nextBatch = this.devices.slice(this.currentIndex, this.currentIndex + this.batchSize);
            this.visibleDevices = this.visibleDevices.concat(nextBatch);
            this.currentIndex += this.batchSize;
            this.hasMore = this.currentIndex < this.devices.length;
            this.loadingMore = false;
          }, 500);
        },
        handleScroll() {
          const scrollBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 10;
          if (scrollBottom) this.loadMore();
        },
        goToDetail(id) {
          window.location.href = `device.html?id=${id}`;
        }
      }
    });
  </script>
</body>

</html>
