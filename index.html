<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>设备管理主页</title>
  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .device-card {
      margin-bottom: 20px;
      cursor: pointer;
      transition: 0.2s;
    }

    .device-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .announcement {
      margin-bottom: 30px;
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <el-card v-if="!unlocked" class="announcement">
      <h3>请输入访问密码</h3>
      <el-input v-model="inputPassword" placeholder="请输入密码" show-password style="width: 300px; margin-bottom: 10px;"></el-input>
      <br />
      <el-button type="primary" @click="checkPassword">确定</el-button>
    </el-card>

    <div v-else>
      <!-- 公告栏 -->
      <el-alert v-for="(notice, index) in announcements.slice(0, 3)" :key="index" type="info" :title="notice"
        show-icon class="announcement"></el-alert>

      <!-- 设备列表 -->
      <el-row :gutter="20">
        <el-col :span="12" v-for="device in visibleDevices" :key="device.id">
          <el-card class="device-card" @click="goToDevice(device.id)">
            <h3>{{ device.name || '未命名设备' }}</h3>
            <p><strong>位置：</strong>{{ device.location || '未知' }}</p>
            <p><strong>上次维护：</strong>{{ device.last_maintenance || 'N/A' }}</p>
          </el-card>
        </el-col>
      </el-row>

      <div v-if="loadingMore" style="text-align: center; margin: 20px;">加载中...</div>
      <div v-if="!hasMore" style="text-align: center; color: gray;">没有更多设备了</div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        inputPassword: '',
        unlocked: false,
        devices: [],
        visibleDevices: [],
        announcements: ["设备维护请联系技术部", "周三将进行全网巡检", "请及时更新维护记录"],
        pageSize: 5,
        loadingMore: false,
        hasMore: true,
        lastIndex: 0
      },
      created() {
        window.addEventListener('scroll', this.handleScroll);
      },
      destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
      },
      methods: {
        checkPassword() {
          if (this.inputPassword === '123456') {
            this.unlocked = true;
            this.loadDevices();
          } else {
            this.$message.error("密码错误");
          }
        },
        async loadDevices() {
          const snapshot = await db.ref('devices').once('value');
          const raw = snapshot.val() || {};
          this.devices = Object.entries(raw).map(([id, val]) => ({ id, ...val }));
          this.appendDevices();
        },
        appendDevices() {
          if (this.lastIndex >= this.devices.length) {
            this.hasMore = false;
            return;
          }
          this.loadingMore = true;
          setTimeout(() => {
            const next = this.devices.slice(this.lastIndex, this.lastIndex + this.pageSize);
            this.visibleDevices = this.visibleDevices.concat(next);
            this.lastIndex += this.pageSize;
            this.loadingMore = false;
          }, 500); // 模拟加载延迟
        },
        handleScroll() {
          const scrollBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 50;
          if (scrollBottom && !this.loadingMore && this.hasMore) {
            this.appendDevices();
          }
        },
        goToDevice(id) {
          window.location.href = `detail.html?id=${id}`;
        }
      }
    });
  </script>
</body>

</html>
