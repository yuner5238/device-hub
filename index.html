<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ËÆæÂ§áÁÆ°ÁêÜÁ≥ªÁªü - È¶ñÈ°µ</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif;
      background-color: #f5f5f7;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 920px;
      margin: 0 auto;
      padding: 24px;
    }
    .announcement {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .announcement h2 {
      font-size: 22px;
      margin: 0;
      font-weight: 600;
    }
    .edit-button {
      font-size: 14px;
      cursor: pointer;
      color: #409EFF;
    }
    .announcement-group {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .announcement-group:last-child {
      border-bottom: none;
    }
    .announcement-group strong {
      font-size: 16px;
    }
    .announcement-group small {
      color: #999;
    }

    .device-list {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      overflow: hidden;
    }

    .device-item {
      padding: 20px;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
      cursor: pointer;
    }
    .device-item:hover {
      background-color: #f2f2f2;
    }
    .device-name {
      font-size: 18px;
      font-weight: 500;
    }
    .device-meta {
      color: #666;
      font-size: 14px;
      margin-top: 6px;
    }

    @media (max-width: 600px) {
      .device-name { font-size: 16px; }
      .device-meta { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <!-- ÂÖ¨ÂëäÊ†è -->
    <div class="announcement">
      <div class="announcement-header">
        <h2>üì¢ ÂÖ¨ÂëäÊ†è</h2>
        <span class="edit-button" @click="editAnnouncement">ÁºñËæë</span>
      </div>
      <div v-for="(item, key) in announcements" :key="key" class="announcement-group">
        <strong>{{ item.title }}</strong><br />
        <span>{{ item.content }}</span><br />
        <small>{{ item.date }}</small>
      </div>
    </div>

    <!-- ËÆæÂ§áÂàóË°® -->
    <div class="device-list">
      <div v-for="device in displayedDevices" :key="device.key" class="device-item" @click="goToDevice(device.key)">
        <div class="device-name">{{ device.name }}</div>
        <div class="device-meta">
          {{ device.location }} ¬∑ ÈááË¥≠Êó•ÊúüÔºö{{ device.purchase_date }}<br>
          {{ device.notes }}
        </div>
      </div>
    </div>
  </div>

  <!-- ËÑöÊú¨‰æùËµñ -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>
    // Firebase ÈÖçÁΩÆ
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        announcements: [],
        devices: [],
        displayedDevices: [],
        devicesPerPage: 10,
        currentPage: 0,
        loading: false,
        announcementEditPassword: '123456',
      },
      created() {
        this.fetchAnnouncements();
        this.fetchDevices();
        window.addEventListener('scroll', this.handleScroll);
      },
      destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
      },
      methods: {
        fetchAnnouncements() {
          db.ref('announcements').orderByKey().limitToLast(3).once('value').then(snapshot => {
            let data = snapshot.val() || {};
            let arr = Object.entries(data).map(([k, v]) => v);
            arr.sort((a, b) => new Date(b.date) - new Date(a.date));
            this.announcements = arr.slice(0, 3);
          });
        },
        fetchDevices() {
          db.ref().once('value').then(snapshot => {
            const data = snapshot.val() || {};
            const result = [];
            for (const key in data) {
              if (key === 'announcements') continue;
              const dev = data[key];
              if (dev && dev.name) {
                result.push({ ...dev, key });
              }
            }
            result.sort((a, b) => a.key.localeCompare(b.key));
            this.devices = result;
            this.loadMore();
          });
        },
        loadMore() {
          if (this.loading) return;
          this.loading = true;
          const start = this.currentPage * this.devicesPerPage;
          const next = this.devices.slice(start, start + this.devicesPerPage);
          if (next.length > 0) {
            this.displayedDevices.push(...next);
            this.currentPage++;
          }
          this.loading = false;
        },
        handleScroll() {
          const bottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 20;
          if (bottom) this.loadMore();
        },
        goToDevice(key) {
          window.location.href = `device.html?id=${encodeURIComponent(key)}`;
        },
        editAnnouncement() {
          this.$prompt('ËØ∑ËæìÂÖ•ÁºñËæëÂØÜÁ†Å', 'ÂØÜÁ†ÅÈ™åËØÅ', {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            inputType: 'password',
            inputPlaceholder: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å'
          }).then(({ value }) => {
            if (value === this.announcementEditPassword) {
              this.openAnnouncementEditor();
            } else {
              this.$message.error('ÂØÜÁ†ÅÈîôËØØ');
            }
          }).catch(() => {});
        },
        openAnnouncementEditor() {
          let promises = [];
          for (let i = 0; i < this.announcements.length; i++) {
            let ann = this.announcements[i];
            promises.push(this.$prompt(`ÁºñËæëÂÖ¨ÂëäÊ†áÈ¢òÔºàÁ¨¨${i + 1}Êù°Ôºâ`, 'ÁºñËæëÂÖ¨Âëä', {
              confirmButtonText: 'Á°ÆÂÆö',
              cancelButtonText: 'Ë∑≥Ëøá',
              inputValue: ann.title
            }).then(({ value }) => {
              ann.title = value;
              return this.$prompt(`ÁºñËæëÂÖ¨ÂëäÂÜÖÂÆπÔºàÁ¨¨${i + 1}Êù°Ôºâ`, 'ÁºñËæëÂÖ¨Âëä', {
                confirmButtonText: 'Á°ÆÂÆö',
                cancelButtonText: 'Ë∑≥Ëøá',
                inputValue: ann.content
              }).then(({ value }) => {
                ann.content = value;
                return ann;
              });
            }).catch(() => ann));
          }
          Promise.all(promises).then(results => {
            db.ref('announcements').once('value').then(snapshot => {
              const all = snapshot.val() || {};
              const keys = Object.keys(all).sort();
              let updates = {};
              for (let i = 0; i < results.length; i++) {
                if (!keys[i]) break;
                updates[`announcements/${keys[i]}/title`] = results[i].title;
                updates[`announcements/${keys[i]}/content`] = results[i].content;
              }
              db.ref().update(updates).then(() => {
                this.$message.success('ÂÖ¨ÂëäÂ∑≤Êõ¥Êñ∞');
                this.fetchAnnouncements();
              });
            });
          });
        }
      }
    });
  </script>
</body>
</html>
