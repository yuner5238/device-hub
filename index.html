<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>设备管理系统</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <style>
    /* 极简苹果风格基础样式 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f8f8f8;
      color: #1d1d1f;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 24px auto;
      padding: 0 16px;
    }
    h2 {
      font-weight: 600;
      margin-bottom: 16px;
      color: #1d1d1f;
    }
    .announcement {
      background: #fff;
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    }
    .announcement-title {
      font-weight: 600;
      font-size: 1.15rem;
      margin-bottom: 4px;
    }
    .announcement-date {
      color: #6e6e73;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }
    .announcement-content {
      font-size: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .device-list {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
      gap: 16px;
    }
    .device-card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      transition: box-shadow 0.25s ease;
      user-select: none;
    }
    .device-card:hover {
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.15);
    }
    .device-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 6px;
      color: #1d1d1f;
    }
    .device-location {
      font-size: 0.9rem;
      color: #6e6e73;
    }

    /* 手机端单列 */
    @media (max-width: 600px) {
      .device-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <h2>公告栏
      <el-button type="text" @click="tryEditAnnouncements" size="small">编辑公告</el-button>
    </h2>
    <div v-if="announcements.length === 0" class="announcement">暂无公告</div>
    <div v-for="(ann, idx) in announcements" :key="idx" class="announcement">
      <div class="announcement-title">{{ ann.title }}</div>
      <div class="announcement-date">{{ ann.date }}</div>
      <div class="announcement-content">{{ ann.content }}</div>
    </div>

    <h2>设备列表</h2>
    <div class="device-list">
      <div v-for="device in visibleDevices" :key="device.id" class="device-card" @click="goToDevice(device.id)">
        <div class="device-name">{{ device.name }}</div>
        <div class="device-location">{{ device.location }}</div>
      </div>
    </div>

    <el-dialog title="编辑公告" :visible.sync="editingAnnouncements" width="600px" :before-close="closeEditDialog">
      <div v-for="(ann, idx) in announcements" :key="idx" style="margin-bottom: 16px;">
        <el-input v-model="ann.title" placeholder="标题" style="margin-bottom:6px;"></el-input>
        <el-input type="textarea" v-model="ann.content" placeholder="内容"></el-input>
        <el-input v-model="ann.date" placeholder="日期(YYYY-MM-DD)" style="margin-top:6px;"></el-input>
        <el-button type="danger" @click="removeAnnouncement(idx)" size="mini" style="margin-top:6px;">删除</el-button>
        <hr />
      </div>
      <el-button type="primary" @click="addAnnouncement" style="margin-top: 12px;">新增公告</el-button>
      <span slot="footer" class="dialog-footer">
        <el-button @click="editingAnnouncements = false">取消</el-button>
        <el-button type="primary" :loading="savingAnnouncements" @click="saveAnnouncements">保存</el-button>
      </span>
    </el-dialog>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase 初始化，替换为你的配置
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data() {
        return {
          announcements: [],
          editingAnnouncements: false,
          savingAnnouncements: false,
          devicesBatchSize: 12,
          visibleDevices: [],
          devicesLoadedCount: 0,
          loadingDevices: false,
          noMoreDevices: false,
        };
      },
      created() {
        this.loadAnnouncements();
        this.loadDevicesBatch();
        window.addEventListener('scroll', this.onScroll);
      },
      methods: {
        loadAnnouncements() {
          db.ref('announcements').once('value').then(snapshot => {
            const anns = [];
            snapshot.forEach(child => {
              anns.push(child.val());
            });
            // 按日期倒序排，只显示最多3条
            anns.sort((a,b) => b.date.localeCompare(a.date));
            this.announcements = anns.slice(0,3);
          });
        },
        tryEditAnnouncements() {
          this.$prompt('请输入编辑密码', '密码验证', {
            inputType: 'password',
            confirmButtonText: '确认',
            cancelButtonText: '取消',
          }).then(({ value }) => {
            if (value === '123456') {
              this.editingAnnouncements = true;
              this.loadAnnouncementsForEdit();
            } else {
              this.$message.error('密码错误');
            }
          }).catch(() => {});
        },
        loadAnnouncementsForEdit() {
          db.ref('announcements').once('value').then(snapshot => {
            const anns = [];
            snapshot.forEach(child => {
              anns.push(child.val());
            });
            // 编辑时取全部，按日期倒序
            anns.sort((a,b) => b.date.localeCompare(a.date));
            this.announcements = anns;
          });
        },
        addAnnouncement() {
          this.announcements.unshift({ title: '', content: '', date: new Date().toISOString().slice(0,10) });
        },
        removeAnnouncement(idx) {
          this.announcements.splice(idx,1);
        },
        saveAnnouncements() {
          if (this.savingAnnouncements) return;
          this.savingAnnouncements = true;
          const updates = {};
          this.announcements.forEach((ann, i) => {
            updates[i] = { title: ann.title, content: ann.content, date: ann.date };
          });
          db.ref('announcements').set(updates).then(() => {
            this.$message.success('公告保存成功');
            this.editingAnnouncements = false;
            this.loadAnnouncements();
          }).catch(() => {
            this.$message.error('保存失败，请重试');
          }).finally(() => {
            this.savingAnnouncements = false;
          });
        },
        loadDevicesBatch() {
          if (this.loadingDevices || this.noMoreDevices) return;
          this.loadingDevices = true;
          db.ref('devices').orderByKey().limitToFirst(this.devicesLoadedCount + this.devicesBatchSize).once('value').then(snapshot => {
            const devicesArr = [];
            snapshot.forEach(child => {
              const val = child.val();
              devicesArr.push({
                id: child.key,
                name: val.name || child.key,
                location: val.location || ''
              });
            });
            const newlyLoaded = devicesArr.slice(this.devicesLoadedCount, this.devicesLoadedCount + this.devicesBatchSize);
            this.visibleDevices = this.visibleDevices.concat(newlyLoaded);
            this.devicesLoadedCount += newlyLoaded.length;
            if (newlyLoaded.length < this.devicesBatchSize) {
              this.noMoreDevices = true;
            }
          }).catch(() => {
            this.$message.error('加载设备失败');
          }).finally(() => {
            this.loadingDevices = false;
          });
        },
        onScroll() {
          const scrollBottom = window.innerHeight + window.scrollY;
          const pageHeight = document.documentElement.scrollHeight;
          if (scrollBottom + 200 >= pageHeight) {
            this.loadDevicesBatch();
          }
        },
        goToDevice(id) {
          window.location.href = `device.html?id=${encodeURIComponent(id)}`;
        },
        closeEditDialog(done) {
          this.editingAnnouncements = false;
          done();
        }
      },
      beforeDestroy() {
        window.removeEventListener('scroll', this.onScroll);
      }
    });
  </script>
</body>
</html>
