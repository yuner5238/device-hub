<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>设备管理主页</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    /* 苹果风格基础色调 */
    body {
      margin: 0;
      background: #fefefe;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #1d1d1f;
      padding: 24px 16px;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #app {
      max-width: 600px;
      margin: 0 auto;
    }

    /* 标题 */
    h1 {
      font-weight: 600;
      font-size: 28px;
      margin-bottom: 24px;
      user-select: text;
      color: #1d1d1f;
      letter-spacing: 0.02em;
    }

    /* 公告栏 */
    .announcement {
      background: #f5f5f7;
      border-radius: 14px;
      padding: 14px 20px;
      margin-bottom: 32px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
      color: #6e6e73;
      font-weight: 400;
      font-size: 15px;
      user-select: text;
      line-height: 1.4;
      cursor: default;
      transition: background-color 0.3s ease;
    }

    .announcement:focus-within {
      background: #e9e9ec;
    }

    .announcement-editable {
      margin-top: 8px;
      width: 100%;
    }

    /* 设备列表 */
    .device-list {
      list-style: none;
      padding: 0;
      margin: 0;
      user-select: text;
    }

    .device-item {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgb(0 0 0 / 0.07);
      padding: 18px 24px;
      margin-bottom: 18px;
      cursor: pointer;
      transition: box-shadow 0.25s ease, transform 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .device-item:hover {
      box-shadow: 0 8px 28px rgb(0 0 0 / 0.12);
      transform: translateY(-3px);
    }

    .device-name {
      font-weight: 600;
      font-size: 20px;
      color: #1d1d1f;
      margin-bottom: 6px;
      line-height: 1.2;
      user-select: text;
    }

    .device-location {
      font-size: 14px;
      font-weight: 400;
      color: #6e6e73;
      user-select: text;
      letter-spacing: 0.01em;
    }

    /* 按钮 */
    .edit-btn {
      margin-top: 10px;
      width: 110px;
    }

    /* 编辑密码框 */
    .password-input {
      margin-top: 8px;
      margin-bottom: 20px;
      max-width: 320px;
      user-select: text;
    }

    /* 编辑公告区域 */
    .edit-area {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d1d6;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 400;
      color: #1d1d1f;
      resize: vertical;
      min-height: 50px;
      font-family: inherit;
      user-select: text;
      outline: none;
      transition: border-color 0.25s ease;
    }

    .edit-area:focus {
      border-color: #0071e3;
      box-shadow: 0 0 6px #0071e3aa;
    }

    /* 响应式调整 */
    @media (max-width: 440px) {
      body {
        padding: 16px 12px;
      }
      .device-item {
        padding: 14px 18px;
      }
      .device-name {
        font-size: 18px;
      }
      .device-location {
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <h1>设备管理主页</h1>

    <!-- 公告栏 -->
    <div
      tabindex="0"
      class="announcement"
      v-if="!editingAnnouncement"
      @dblclick="startEditAnnouncement"
      title="双击编辑公告"
      role="region"
      aria-label="公告栏"
    >
      <div v-for="(item, idx) in announcements" :key="idx" style="margin-bottom: 8px;" v-text="item"></div>
      <div style="font-size: 13px; color: #999;">（双击此处编辑公告，最多三条）</div>
    </div>

    <div v-else>
      <textarea
        class="edit-area"
        v-model="announcementText"
        placeholder="请输入公告，分行显示，最多三条"
        rows="4"
        maxlength="150"
      ></textarea>
      <el-input
        v-model="editPassword"
        class="password-input"
        type="password"
        placeholder="请输入编辑密码"
        show-password
        clearable
      ></el-input>
      <div>
        <el-button size="small" type="primary" @click="saveAnnouncement">保存</el-button>
        <el-button size="small" @click="cancelEditAnnouncement">取消</el-button>
      </div>
    </div>

    <!-- 设备列表 -->
    <ul class="device-list" aria-label="设备列表">
      <li
        class="device-item"
        v-for="device in devices"
        :key="device.id"
        role="listitem"
        @click="goToDevice(device.id)"
        tabindex="0"
        @keydown.enter.space.prevent="goToDevice(device.id)"
        aria-describedby="device-location-{{device.id}}"
      >
        <div class="device-name" v-text="device.name || '未命名设备'"></div>
        <div class="device-location" :id="'device-location-' + device.id" v-text="'位置: ' + (device.location || '未知')"></div>
      </li>
    </ul>
  </div>

  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.appspot.com",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: "#app",
      data: {
        devices: [],
        announcements: ["设备维护请联系技术部", "周三将进行全网巡检", "请及时更新维护记录"],
        editingAnnouncement: false,
        announcementText: "",
        editPassword: "",
      },
      created() {
        this.loadDevices();
      },
      methods: {
        async loadDevices() {
          try {
            const snapshot = await db.ref("devices").once("value");
            const data = snapshot.val() || {};
            this.devices = Object.entries(data).map(([id, val]) => ({ id, ...val }));
          } catch (e) {
            console.error("加载设备失败", e);
          }
        },
        goToDevice(id) {
          window.location.href = `detail.html?id=${id}`;
        },
        startEditAnnouncement() {
          this.announcementText = this.announcements.join("\n");
          this.editingAnnouncement = true;
          this.$nextTick(() => {
            const textarea = document.querySelector(".edit-area");
            if (textarea) textarea.focus();
          });
        },
        async saveAnnouncement() {
          if (this.editPassword !== "123456") {
            this.$message.error("编辑密码错误");
            return;
          }
          // 拆行取前3条，不允许空行
          const lines = this.announcementText
            .split("\n")
            .map((l) => l.trim())
            .filter((l) => l.length > 0)
            .slice(0, 3);
          this.announcements = lines.length ? lines : ["暂无公告"];
          this.editingAnnouncement = false;
          this.editPassword = "";
          this.$message.success("公告更新成功");

          // 这里你可以把公告存到 Firebase 或其他存储
          // await db.ref('announcements').set(this.announcements);
        },
        cancelEditAnnouncement() {
          this.editingAnnouncement = false;
          this.editPassword = "";
        },
      },
    });
  </script>
</body>

</html>
