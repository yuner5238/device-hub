<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è®¾å¤‡ç®¡ç†ç³»ç»Ÿ - é¦–é¡µ</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif;
      background-color: #f5f5f7;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .announcement {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .announcement h2 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
    }
    .device-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      transition: box-shadow 0.2s ease;
      cursor: pointer;
    }
    .device-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .device-name {
      font-size: 18px;
      font-weight: 500;
    }
    .device-meta {
      color: #888;
      font-size: 14px;
      margin-top: 6px;
    }
    .edit-button {
      font-size: 14px;
      cursor: pointer;
      color: #409EFF;
      user-select: none;
    }
    @media (max-width: 600px) {
      .device-card {
        padding: 12px;
      }
      .device-name {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="announcement">
      <div class="announcement-header">
        <h2>ğŸ“¢ å…¬å‘Šæ </h2>
        <span class="edit-button" @click="editAnnouncement">ç¼–è¾‘</span>
      </div>
      <div v-for="(item, key) in announcements" :key="key" style="margin-bottom: 8px;">
        <strong>{{ item.title }}</strong><br />
        <span>{{ item.content }}</span><br />
        <small style="color: #999;">{{ item.date }}</small>
      </div>
    </div>

    <div v-for="device in displayedDevices" :key="device.key" class="device-card" @click="goToDevice(device.key)">
      <div class="device-name">{{ device.name }}</div>
      <div class="device-meta">{{ device.location }} Â· é‡‡è´­æ—¥æœŸ: {{ device.purchase_date }}</div>
    </div>

    <el-button v-if="hasMore" @click="loadMore" type="primary" size="small" style="margin: 16px auto; display: block;">
      åŠ è½½æ›´å¤šè®¾å¤‡
    </el-button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>
    // Firebase é…ç½®ï¼Œé»˜è®¤å¸®ä½ å¸¦ä¸Š
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        announcements: {},
        devices: [],
        displayedDevices: [],
        devicesPerPage: 10,
        currentPage: 0,
        hasMore: true,
        // å¯†ç æç¤ºç›¸å…³
        announcementEditPassword: '123456',
      },
      created() {
        this.fetchAnnouncements();
        this.fetchDevices();
      },
      methods: {
        fetchAnnouncements() {
          db.ref('announcements').orderByKey().limitToLast(3).once('value').then(snapshot => {
            let data = snapshot.val() || {};
            // æŒ‰æ—¥æœŸå€’åºæ’åº
            let arr = Object.entries(data).map(([key, val]) => val);
            arr.sort((a,b) => new Date(b.date) - new Date(a.date));
            // åªä¿ç•™æœ€æ–°3æ¡
            this.announcements = arr.slice(0,3);
          });
        },
        fetchDevices() {
          db.ref().once('value').then(snapshot => {
            const data = snapshot.val() || {};
            // è¿‡æ»¤å‡ºè®¾å¤‡èŠ‚ç‚¹ï¼Œæ’é™¤ announcements
            const devices = [];
            for (const key in data) {
              if (key === 'announcements') continue;
              const dev = data[key];
              if (dev && dev.name && dev.location && dev.purchase_date) {
                devices.push({...dev, key});
              }
            }
            // æŒ‰è®¾å¤‡ key æ’åºï¼ˆå­—æ¯æ•°å­—å‡åºï¼‰
            devices.sort((a,b) => a.key.localeCompare(b.key));
            this.devices = devices;
            this.loadMore();
          });
        },
        loadMore() {
          const start = this.currentPage * this.devicesPerPage;
          const end = start + this.devicesPerPage;
          const nextBatch = this.devices.slice(start, end);
          if (nextBatch.length === 0) {
            this.hasMore = false;
            return;
          }
          this.displayedDevices = this.displayedDevices.concat(nextBatch);
          this.currentPage++;
          this.hasMore = this.devices.length > this.displayedDevices.length;
        },
        goToDevice(key) {
          // ç›´æ¥è·³è½¬ï¼Œkeyå·²å…¨éƒ¨æ˜¯è‹±æ–‡
          window.location.href = `device.html?id=${encodeURIComponent(key)}`;
        },
        editAnnouncement() {
          this.$prompt('è¯·è¾“å…¥ç¼–è¾‘å¯†ç ', 'å¯†ç éªŒè¯', {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            inputType: 'password',
            inputPlaceholder: 'è¯·è¾“å…¥å¯†ç '
          }).then(({ value }) => {
            if (value === this.announcementEditPassword) {
              this.openAnnouncementEditor();
            } else {
              this.$message.error('å¯†ç é”™è¯¯');
            }
          }).catch(() => {});
        },
        openAnnouncementEditor() {
          // ç®€æ˜“ç¼–è¾‘å…¬å‘Šï¼šè¿™é‡Œåªå…è®¸ç¼–è¾‘å‰ä¸‰æ¡å…¬å‘Šçš„å†…å®¹å’Œæ ‡é¢˜
          // å¼¹çª—è¾“å…¥ï¼Œé€æ¡ç¼–è¾‘ï¼ˆä¹Ÿå¯ä»¥æŒ‰éœ€æ”¹è¿›æˆæ›´å¤æ‚UIï¼‰
          let promises = [];
          for(let i=0; i< this.announcements.length; i++){
            let ann = this.announcements[i];
            promises.push(this.$prompt(`ç¼–è¾‘å…¬å‘Šæ ‡é¢˜ï¼ˆç¬¬${i+1}æ¡ï¼‰`, 'ç¼–è¾‘å…¬å‘Š', {
              confirmButtonText: 'ç¡®å®š',
              cancelButtonText: 'è·³è¿‡',
              inputValue: ann.title,
              inputPlaceholder: 'æ ‡é¢˜'
            }).then(({value})=>{
              ann.title = value;
              return this.$prompt(`ç¼–è¾‘å…¬å‘Šå†…å®¹ï¼ˆç¬¬${i+1}æ¡ï¼‰`, 'ç¼–è¾‘å…¬å‘Š', {
                confirmButtonText: 'ç¡®å®š',
                cancelButtonText: 'è·³è¿‡',
                inputValue: ann.content,
                inputPlaceholder: 'å†…å®¹'
              }).then(({value})=>{
                ann.content = value;
                return ann;
              });
            }).catch(()=>{
              // è·³è¿‡ç¼–è¾‘æ­¤æ¡å…¬å‘Š
              return ann;
            }));
          }
          Promise.all(promises).then(results => {
            // æ›´æ–°åˆ°æ•°æ®åº“
            // å…ˆè¯»å–æ‰€æœ‰å…¬å‘Š key æ’åºï¼ŒåŒ¹é…å‰3æ¡æ›´æ–°
            db.ref('announcements').once('value').then(snapshot=>{
              const allAnnouncements = snapshot.val() || {};
              const keys = Object.keys(allAnnouncements).sort();
              let updates = {};
              for(let i=0; i<results.length; i++){
                if(i >= keys.length) break;
                updates[`announcements/${keys[i]}/title`] = results[i].title;
                updates[`announcements/${keys[i]}/content`] = results[i].content;
              }
              db.ref().update(updates).then(()=>{
                this.$message.success('å…¬å‘Šå·²æ›´æ–°');
                this.fetchAnnouncements();
              }).catch(()=>{
                this.$message.error('æ›´æ–°å¤±è´¥');
              });
            });
          });
        }
      }
    });
  </script>
</body>
</html>
