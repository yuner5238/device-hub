<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ËÆæÂ§áÁÆ°ÁêÜÁ≥ªÁªü</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Segoe UI", Roboto, "Hiragino Sans GB", sans-serif;
      background-color: #f8f8f8;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .announcements {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 30px;
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .device-card {
      background-color: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .device-card:hover {
      transform: translateY(-2px);
    }
    .device-title {
      font-weight: 500;
      font-size: 16px;
      color: #111;
    }
    .device-sub {
      color: #888;
      font-size: 14px;
      margin-top: 4px;
    }
    .edit-area {
      margin-top: 10px;
    }
    .el-input, .el-button {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <!-- ÂÖ¨ÂëäÊ†è -->
    <div class="announcements">
      <div class="announcement-header">
        <h3>üì¢ ÂÖ¨ÂëäÊ†è</h3>
        <el-button type="text" @click="editing = !editing">{{ editing ? 'ÂèñÊ∂à' : 'ÁºñËæë' }}</el-button>
      </div>
      <div v-if="!editing">
        <div v-for="(item, key) in announcementList" :key="key" style="margin-bottom: 12px;">
          <strong>{{ item.title }}</strong>Ôºà{{ item.date }}Ôºâ<br />
          <span style="color: #555;">{{ item.content }}</span>
        </div>
      </div>
      <div v-else class="edit-area">
        <el-input v-model="editPassword" placeholder="ËØ∑ËæìÂÖ•ÁºñËæëÂØÜÁ†Å" show-password></el-input>
        <div v-for="(item, key, index) in announcementList" :key="key" style="margin-top: 10px;">
          <el-input v-model="item.title" placeholder="Ê†áÈ¢ò"></el-input>
          <el-input v-model="item.content" placeholder="ÂÜÖÂÆπ"></el-input>
          <el-date-picker v-model="item.date" type="date" placeholder="Êó•Êúü" style="width: 100%;"></el-date-picker>
        </div>
        <el-button type="primary" @click="saveAnnouncements">‰øùÂ≠ò</el-button>
      </div>
    </div>

    <!-- ËÆæÂ§áÂàóË°® -->
    <div v-for="(device, key) in visibleDevices" :key="key" class="device-card" @click="goToDevice(key)">
      <div class="device-title">{{ device.name }}</div>
      <div class="device-sub">{{ device.location }}</div>
    </div>

    <!-- Âä†ËΩΩÊèêÁ§∫ -->
    <el-empty v-if="!loading && visibleDevices.length === 0" description="ÊöÇÊó†ËÆæÂ§á"></el-empty>
    <div v-if="loading" style="text-align: center; margin-top: 20px;">
      <el-spinner type="snake"></el-spinner>
    </div>
  </div>

  <!-- Firebase + Vue + Element UI -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>

  <script>
    // ‚úÖ Áî®‰Ω†ÁöÑ Firebase È°πÁõÆÈÖçÁΩÆÊõøÊç¢ËøôÈáåÔºö
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        devices: {},
        visibleDevices: [],
        batchSize: 10,
        loadedCount: 0,
        loading: false,
        announcementList: {},
        editing: false,
        editPassword: ''
      },
      created() {
        this.fetchAnnouncements();
        this.fetchDevices();
        window.addEventListener('scroll', this.handleScroll);
      },
      methods: {
        fetchAnnouncements() {
          db.ref("announcements").once("value").then(snapshot => {
            this.announcementList = snapshot.val() || {};
          });
        },
        saveAnnouncements() {
          if (this.editPassword !== '123456') {
            this.$message.error("ÂØÜÁ†ÅÈîôËØØ");
            return;
          }
          db.ref("announcements").set(this.announcementList).then(() => {
            this.editing = false;
            this.$message.success("Â∑≤‰øùÂ≠òÂÖ¨Âëä");
          });
        },
        fetchDevices() {
          db.ref("devices").once("value").then(snapshot => {
            this.devices = snapshot.val() || {};
            this.loadMore();
          });
        },
        loadMore() {
          if (this.loading) return;
          this.loading = true;
          const keys = Object.keys(this.devices);
          const nextBatch = keys.slice(this.loadedCount, this.loadedCount + this.batchSize);
          nextBatch.forEach(key => {
            this.visibleDevices.push({ ...this.devices[key], key });
          });
          this.loadedCount += this.batchSize;
          this.loading = false;
        },
        handleScroll() {
          const scrollY = window.scrollY;
          const visibleHeight = document.documentElement.clientHeight;
          const pageHeight = document.documentElement.scrollHeight;
          if (scrollY + visibleHeight >= pageHeight - 100) {
            this.loadMore();
          }
        },
        goToDevice(key) {
          window.location.href = `device.html?id=${encodeURIComponent(key)}`;
        }
      }
    });
  </script>
</body>
</html>
