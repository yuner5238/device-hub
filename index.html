<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ËÆæÂ§áÁÆ°ÁêÜÁ≥ªÁªü - È¶ñÈ°µ</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif;
      background-color: #f5f5f7;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }
    .announcement {
      background: white;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .announcement h2 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
    }
    .edit-button {
      font-size: 14px;
      cursor: pointer;
      color: #409EFF;
      user-select: none;
    }
    .device-list {
      background: white;
      border-radius: 14px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .device-item {
      padding: 18px 20px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .device-item:hover {
      background: #fafafa;
    }
    .device-name {
      font-size: 17px;
      font-weight: 500;
    }
    .device-meta {
      font-size: 14px;
      color: #888;
      margin-top: 6px;
    }
    .device-notes {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    @media (max-width: 600px) {
      .device-item {
        padding: 14px 16px;
      }
      .device-name {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="announcement">
      <div class="announcement-header">
        <h2>üì¢ ÂÖ¨ÂëäÊ†è</h2>
        <span class="edit-button" @click="editAnnouncement">ÁºñËæë</span>
      </div>
      <div v-for="(item, key) in announcements" :key="key" style="margin-bottom: 12px;">
        <strong>{{ item.title }}</strong><br />
        <span>{{ item.content }}</span><br />
        <small style="color: #999;">{{ item.date }}</small>
      </div>
    </div>

    <div class="device-list">
      <div v-for="device in displayedDevices" :key="device.key" class="device-item" @click="goToDevice(device.key)">
        <div class="device-name">{{ device.name }}</div>
        <div class="device-meta">{{ device.location }} ¬∑ ÈááË¥≠: {{ device.purchase_date }}</div>
        <div class="device-notes" v-if="device.notes">Â§áÊ≥®Ôºö{{ device.notes }}</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        announcements: [],
        devices: [],
        displayedDevices: [],
        devicesPerPage: 10,
        currentPage: 0,
        hasMore: true,
        announcementEditPassword: '123456'
      },
      created() {
        this.fetchAnnouncements();
        this.fetchDevices();
        window.addEventListener('scroll', this.onScroll);
      },
      beforeDestroy() {
        window.removeEventListener('scroll', this.onScroll);
      },
      methods: {
        fetchAnnouncements() {
          db.ref('announcements').orderByKey().limitToLast(3).once('value').then(snapshot => {
            let data = snapshot.val() || {};
            let arr = Object.entries(data).map(([key, val]) => val);
            arr.sort((a, b) => new Date(b.date) - new Date(a.date));
            this.announcements = arr.slice(0, 3);
          });
        },
        fetchDevices() {
          db.ref().once('value').then(snapshot => {
            const data = snapshot.val() || {};
            const devices = [];
            for (const key in data) {
              if (key === 'announcements') continue;
              const dev = data[key];
              if (dev && dev.name && dev.location && dev.purchase_date) {
                devices.push({ ...dev, key });
              }
            }
            devices.sort((a, b) => a.key.localeCompare(b.key));
            this.devices = devices;
            this.loadMore();
          });
        },
        loadMore() {
          if (!this.hasMore) return;
          const start = this.currentPage * this.devicesPerPage;
          const end = start + this.devicesPerPage;
          const nextBatch = this.devices.slice(start, end);
          if (nextBatch.length === 0) {
            this.hasMore = false;
            return;
          }
          this.displayedDevices = this.displayedDevices.concat(nextBatch);
          this.currentPage++;
          this.hasMore = this.devices.length > this.displayedDevices.length;
        },
        onScroll() {
          const scrollY = window.scrollY || window.pageYOffset;
          const visibleHeight = window.innerHeight;
          const pageHeight = document.documentElement.scrollHeight;
          if (scrollY + visibleHeight + 80 >= pageHeight) {
            this.loadMore();
          }
        },
        goToDevice(key) {
          window.location.href = `device.html?id=${encodeURIComponent(key)}`;
        },
        editAnnouncement() {
          this.$prompt('ËØ∑ËæìÂÖ•ÁºñËæëÂØÜÁ†Å', 'ÂØÜÁ†ÅÈ™åËØÅ', {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            inputType: 'password',
            inputPlaceholder: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å'
          }).then(({ value }) => {
            if (value === this.announcementEditPassword) {
              this.openAnnouncementEditor();
            } else {
              this.$message.error('ÂØÜÁ†ÅÈîôËØØ');
            }
          }).catch(() => {});
        },
        openAnnouncementEditor() {
          let promises = [];
          for (let i = 0; i < this.announcements.length; i++) {
            let ann = this.announcements[i];
            promises.push(this.$prompt(`ÁºñËæëÂÖ¨ÂëäÊ†áÈ¢òÔºàÁ¨¨${i + 1}Êù°Ôºâ`, 'ÁºñËæëÂÖ¨Âëä', {
              confirmButtonText: 'Á°ÆÂÆö',
              cancelButtonText: 'Ë∑≥Ëøá',
              inputValue: ann.title
            }).then(({ value }) => {
              ann.title = value;
              return this.$prompt(`ÁºñËæëÂÖ¨ÂëäÂÜÖÂÆπÔºàÁ¨¨${i + 1}Êù°Ôºâ`, 'ÁºñËæëÂÖ¨Âëä', {
                confirmButtonText: 'Á°ÆÂÆö',
                cancelButtonText: 'Ë∑≥Ëøá',
                inputValue: ann.content
              }).then(({ value }) => {
                ann.content = value;
                return ann;
              });
            }).catch(() => ann));
          }

          Promise.all(promises).then(results => {
            db.ref('announcements').once('value').then(snapshot => {
              const all = snapshot.val() || {};
              const keys = Object.keys(all).sort();
              let updates = {};
              for (let i = 0; i < results.length; i++) {
                if (i >= keys.length) break;
                updates[`announcements/${keys[i]}/title`] = results[i].title;
                updates[`announcements/${keys[i]}/content`] = results[i].content;
              }
              db.ref().update(updates).then(() => {
                this.$message.success('ÂÖ¨ÂëäÂ∑≤Êõ¥Êñ∞');
                this.fetchAnnouncements();
              }).catch(() => {
                this.$message.error('Êõ¥Êñ∞Â§±Ë¥•');
              });
            });
          });
        }
      }
    });
  </script>
</body>
</html>
