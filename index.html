<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>设备管理系统 - 首页</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif;
      background-color: #f5f5f7;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .announcement {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .announcement h2 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
    }
    .device-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      transition: box-shadow 0.2s ease;
      cursor: pointer;
    }
    .device-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .device-name {
      font-size: 18px;
      font-weight: 500;
    }
    .device-meta {
      color: #888;
      font-size: 14px;
      margin-top: 6px;
    }
    .edit-button {
      font-size: 14px;
      cursor: pointer;
      color: #409EFF;
      user-select: none;
    }
    @media (max-width: 600px) {
      .device-card {
        padding: 12px;
      }
      .device-name {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="announcement">
      <div class="announcement-header">
        <h2>📢 公告栏</h2>
        <span class="edit-button" @click="editAnnouncement">编辑</span>
      </div>
      <div v-for="(item, key) in announcements" :key="key" style="margin-bottom: 8px;">
        <strong>{{ item.title }}</strong><br />
        <span>{{ item.content }}</span><br />
        <small style="color: #999;">{{ item.date }}</small>
      </div>
    </div>

    <div v-for="device in displayedDevices" :key="device.key" class="device-card" @click="goToDevice(device.key)">
      <div class="device-name">{{ device.name }}</div>
      <div class="device-meta">{{ device.location }} · 采购日期: {{ device.purchase_date }}</div>
    </div>

    <el-button v-if="hasMore" @click="loadMore" type="primary" size="small" style="margin: 16px auto; display: block;">
      加载更多设备
    </el-button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>
    // Firebase 配置，默认帮你带上
    const firebaseConfig = {
      apiKey: "AIzaSyAiNEktrGgrjNfgpHVA6q1aBtDoZ6c5fMM",
      authDomain: "device-hub-5238.firebaseapp.com",
      databaseURL: "https://device-hub-5238-default-rtdb.firebaseio.com",
      projectId: "device-hub-5238",
      storageBucket: "device-hub-5238.firebasestorage.app",
      messagingSenderId: "648686550801",
      appId: "1:648686550801:web:2f460487e32914042316b0",
      measurementId: "G-44L5PHN36Y"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    new Vue({
      el: '#app',
      data: {
        announcements: {},
        devices: [],
        displayedDevices: [],
        devicesPerPage: 10,
        currentPage: 0,
        hasMore: true,
        // 密码提示相关
        announcementEditPassword: '123456',
      },
      created() {
        this.fetchAnnouncements();
        this.fetchDevices();
      },
      methods: {
        fetchAnnouncements() {
          db.ref('announcements').orderByKey().limitToLast(3).once('value').then(snapshot => {
            let data = snapshot.val() || {};
            // 按日期倒序排序
            let arr = Object.entries(data).map(([key, val]) => val);
            arr.sort((a,b) => new Date(b.date) - new Date(a.date));
            // 只保留最新3条
            this.announcements = arr.slice(0,3);
          });
        },
        fetchDevices() {
          db.ref().once('value').then(snapshot => {
            const data = snapshot.val() || {};
            // 过滤出设备节点，排除 announcements
            const devices = [];
            for (const key in data) {
              if (key === 'announcements') continue;
              const dev = data[key];
              if (dev && dev.name && dev.location && dev.purchase_date) {
                devices.push({...dev, key});
              }
            }
            // 按设备 key 排序（字母数字升序）
            devices.sort((a,b) => a.key.localeCompare(b.key));
            this.devices = devices;
            this.loadMore();
          });
        },
        loadMore() {
          const start = this.currentPage * this.devicesPerPage;
          const end = start + this.devicesPerPage;
          const nextBatch = this.devices.slice(start, end);
          if (nextBatch.length === 0) {
            this.hasMore = false;
            return;
          }
          this.displayedDevices = this.displayedDevices.concat(nextBatch);
          this.currentPage++;
          this.hasMore = this.devices.length > this.displayedDevices.length;
        },
        goToDevice(key) {
          // 直接跳转，key已全部是英文
          window.location.href = `device.html?id=${encodeURIComponent(key)}`;
        },
        editAnnouncement() {
          this.$prompt('请输入编辑密码', '密码验证', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            inputType: 'password',
            inputPlaceholder: '请输入密码'
          }).then(({ value }) => {
            if (value === this.announcementEditPassword) {
              this.openAnnouncementEditor();
            } else {
              this.$message.error('密码错误');
            }
          }).catch(() => {});
        },
        openAnnouncementEditor() {
          // 简易编辑公告：这里只允许编辑前三条公告的内容和标题
          // 弹窗输入，逐条编辑（也可以按需改进成更复杂UI）
          let promises = [];
          for(let i=0; i< this.announcements.length; i++){
            let ann = this.announcements[i];
            promises.push(this.$prompt(`编辑公告标题（第${i+1}条）`, '编辑公告', {
              confirmButtonText: '确定',
              cancelButtonText: '跳过',
              inputValue: ann.title,
              inputPlaceholder: '标题'
            }).then(({value})=>{
              ann.title = value;
              return this.$prompt(`编辑公告内容（第${i+1}条）`, '编辑公告', {
                confirmButtonText: '确定',
                cancelButtonText: '跳过',
                inputValue: ann.content,
                inputPlaceholder: '内容'
              }).then(({value})=>{
                ann.content = value;
                return ann;
              });
            }).catch(()=>{
              // 跳过编辑此条公告
              return ann;
            }));
          }
          Promise.all(promises).then(results => {
            // 更新到数据库
            // 先读取所有公告 key 排序，匹配前3条更新
            db.ref('announcements').once('value').then(snapshot=>{
              const allAnnouncements = snapshot.val() || {};
              const keys = Object.keys(allAnnouncements).sort();
              let updates = {};
              for(let i=0; i<results.length; i++){
                if(i >= keys.length) break;
                updates[`announcements/${keys[i]}/title`] = results[i].title;
                updates[`announcements/${keys[i]}/content`] = results[i].content;
              }
              db.ref().update(updates).then(()=>{
                this.$message.success('公告已更新');
                this.fetchAnnouncements();
              }).catch(()=>{
                this.$message.error('更新失败');
              });
            });
          });
        }
      }
    });
  </script>
</body>
</html>
